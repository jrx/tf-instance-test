user nginx;
worker_processes 1;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

stream {

    # Optional for debugging
    # log_format vault_stream '$remote_addr:$remote_port [$time_local] '
    #                         '$protocol $status $bytes_sent $bytes_received '
    #                         '$session_time "$upstream_addr"';
    # access_log /var/log/nginx/vault_stream_access.log vault_stream;

    upstream vault_cluster {
        # round robin is default
{% for server in vault_servers %}
        server {{ server }} max_fails=3 fail_timeout=10s;
{% endfor %}
    }

    server {
        listen {{ nginx_listen_port }};
        proxy_pass vault_cluster;
        proxy_timeout          30s;
        proxy_connect_timeout   2s;
    }

}